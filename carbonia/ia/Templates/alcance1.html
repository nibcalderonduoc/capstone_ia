{% extends 'partials/base.html' %}
{% block title %}Alcance 1{% endblock %}

{% block content %}
<h1>Filtrar Estadísticas por Ubicación</h1>

<div>
    <label for="region-select">Región:</label>
    <select id="region-select">
        <option value="">Seleccione una región</option>
    </select>
</div>

<div>
    <label for="province-select">Provincia:</label>
    <select id="province-select" disabled>
        <option value="">Seleccione una provincia</option>
    </select>
</div>

<div>
    <label for="commune-select">Comuna:</label>
    <select id="commune-select" disabled>
        <option value="">Seleccione una comuna</option>
    </select>
</div>

<div id="statistics">
    <h2>Estadísticas</h2>
    <p>Selecciona una comuna para ver las estadísticas.</p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const regionSelect = document.getElementById('region-select');
        const provinceSelect = document.getElementById('province-select');
        const communeSelect = document.getElementById('commune-select');
        const statisticsDiv = document.getElementById('statistics');

        // Cargar regiones al cargar la página
        fetchRegions();

        // Función para obtener regiones
        function fetchRegions() {
            fetch('/get_regions/')
                .then(response => response.json())
                .then(data => {
                    data.regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region.id;
                        option.textContent = region.name;
                        regionSelect.appendChild(option);
                    });
                });
        }

        // Evento para cargar provincias al seleccionar una región
        regionSelect.addEventListener('change', () => {
            const regionId = regionSelect.value;
            provinceSelect.innerHTML = '<option value="">Seleccione una provincia</option>';
            communeSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
            provinceSelect.disabled = !regionId;
            communeSelect.disabled = true;

            if (regionId) {
                fetch(`/get_provinces/?region_id=${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.provinces.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province.id;
                            option.textContent = province.name;
                            provinceSelect.appendChild(option);
                        });
                    });
            }
        });

        // Evento para cargar comunas al seleccionar una provincia
        provinceSelect.addEventListener('change', () => {
            const provinceId = provinceSelect.value;
            communeSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
            communeSelect.disabled = !provinceId;

            if (provinceId) {
                fetch(`/get_communes/?province_id=${provinceId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.communes.forEach(commune => {
                            const option = document.createElement('option');
                            option.value = commune.id;
                            option.textContent = commune.name;
                            communeSelect.appendChild(option);
                        });
                    });
            }
        });

        // Evento para cargar estadísticas al seleccionar una comuna
        communeSelect.addEventListener('change', () => {
            const communeId = communeSelect.value;

            if (communeId) {
                fetch(`/get_statistics/?commune_id=${communeId}`)
                    .then(response => response.json())
                    .then(data => {
                        statisticsDiv.innerHTML = `
                            <h2>Estadísticas para ${data.commune}</h2>
                            <p>Total TCO2: ${data.tco2}</p>
                            <p>Consumo: ${data.consumo}</p>
                        `;
                    });
            } else {
                statisticsDiv.innerHTML = `<h2>Estadísticas</h2><p>Selecciona una comuna para ver las estadísticas.</p>`;
            }
        });
    });
</script>
{% endblock %}

