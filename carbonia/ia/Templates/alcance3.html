{% extends 'partials/base.html' %}

{% block title %}Carga de documentos - Alcance 3{% endblock %}

{% block content %}
  <h1 class="page-title">Alcance 3 - Huella de Carbono</h1>

  <!-- Mensaje inicial para agregar ítem -->
  <p id="initial-message" class="initial-message">Agregar ítem</p>

  <div id="item-container" class="item-container">
    <!-- Aquí se agregarán los ítems dinámicamente -->
  </div>

  <div class="add-item-button-container">
    <button id="add-item-btn" onclick="addItem()" class="add-item-btn">
      <i class="fa fa-plus"></i> Agregar Ítem
    </button>
  </div>

  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script>
    const categoryOptions = {
      agua: [
        { label: "Servicios adquiridos - Agua potable: Suministro y tratamiento", unit: "litros" }
      ],
      transporte_aereo: [
        { label: "Viajes de negocios - Aéreo - Avión trayecto internacional (promedio)", unit: "km" }
      ],
      transporte_terrestre: [
        { label: "Transporte de clientes y visitantes - Terrestre - Vehículo particular - Gasolina", unit: "litros" },
        { label: "Transporte de clientes y visitantes - Terrestre - Vehículo particular - Diesel", unit: "litros" }
      ],
      residuos: [
        { label: "Reciclaje - Equipos eléctricos y electrónicos", unit: "kg" },
        { label: "Reciclaje - Metal: latas de aluminio y papel de aluminio", unit: "kg" },
        { label: "Reciclaje - Papel y cartón", unit: "kg" },
        { label: "Reciclaje - Plásticos: PET", unit: "kg" }
      ]
    };

    function addItem() {
      const initialMessage = document.getElementById('initial-message');
      if (initialMessage) {
        initialMessage.style.display = 'none';
      }

      const newItem = document.createElement('div');
      newItem.className = 'item';

      const itemNumber = document.getElementById('item-container').children.length + 1;

      newItem.innerHTML = `
        <div class="item-number">Ítem ${itemNumber}</div>
        <div class="input-group">
          <label>Tipo de Emisión</label>
          <select name="tipo_emision" class="tipo-emision-select" onchange="updateCategoryOptions(this)">
            <option value="">Selecciona el tipo de emisión</option>
            <option value="agua">Agua</option>
            <option value="transporte_aereo">Transporte Aéreo</option>
            <option value="transporte_terrestre">Transporte Terrestre</option>
            <option value="residuos">Residuos</option>
          </select>
        </div>
        <div class="input-group">
          <label>Categoría</label>
          <select name="categoria" class="categoria-select" onchange="updateUnit(this)">
            <option value="">Selecciona la categoría</option>
          </select>
        </div>
        <div class="input-group">
          <label>Valor</label>
          <div class="value-input-container">
            <input type="text" placeholder="Ingresa el valor" class="carbon-value" oninput="validateNumberInput(this)" onkeydown="handleEnter(event)">
            <span class="unit-label">-</span>
          </div>
        </div>
        <button class="remove-item-btn" onclick="removeItem(this)">
          <i class="fa fa-trash"></i> Eliminar
        </button>
      `;

      document.getElementById('item-container').appendChild(newItem);
      updateItemNumbers();

      // Enfocar el nuevo campo de tipo de emisión
      newItem.querySelector('.tipo-emision-select').focus();
    }

    function updateCategoryOptions(selectElement) {
      const itemContainer = selectElement.parentElement.parentElement;
      const categorySelect = itemContainer.querySelector('.categoria-select');
      const unitLabel = itemContainer.querySelector('.unit-label');
      const selectedEmissionType = selectElement.value;

      // Limpia las opciones actuales de categoría y la unidad
      categorySelect.innerHTML = '<option value="">Selecciona la categoría</option>';
      unitLabel.textContent = "-";

      // Agrega las nuevas opciones de acuerdo al tipo de emisión seleccionado
      if (categoryOptions[selectedEmissionType]) {
        categoryOptions[selectedEmissionType].forEach(option => {
          const newOption = document.createElement('option');
          newOption.value = option.unit; // Usamos el valor de unidad para luego mostrarlo
          newOption.textContent = option.label;
          newOption.setAttribute("data-unit", option.unit); // Guardamos la unidad como atributo
          categorySelect.appendChild(newOption);
        });
      }
    }

    function updateUnit(selectElement) {
      const itemContainer = selectElement.parentElement.parentElement;
      const unitLabel = itemContainer.querySelector('.unit-label');
      const selectedOption = selectElement.options[selectElement.selectedIndex];

      // Actualiza la unidad de acuerdo a la opción seleccionada en Categoría
      unitLabel.textContent = selectedOption.getAttribute("data-unit") || "-";
    }

    function validateNumberInput(input) {
      input.value = input.value.replace(/[^0-9.]/g, ''); // Permite solo números y punto decimal
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Evita el comportamiento predeterminado del Enter en formularios
        addItem(); // Llama a la función para agregar un nuevo ítem
      }
    }

    function removeItem(button) {
      button.parentElement.remove();
      updateItemNumbers();
      if (document.getElementById('item-container').children.length === 0) {
        document.getElementById('initial-message').style.display = 'block';
      }
    }

    function updateItemNumbers() {
      const items = document.querySelectorAll('.item');
      items.forEach((item, index) => {
        const itemNumber = item.querySelector('.item-number');
        itemNumber.textContent = `Ítem ${index + 1}`;
      });
    }
  </script>

{% endblock %}
